# CEACore 中樞架構設計文件

## 一、架構目標

1. **建立可重用的 EA 中樞類別** - 整合所有 Libs 模組
2. **抽象層設計** - 多空邏輯可抽換，快速建立新 EA
3. **統一維護** - 減少重複代碼，集中管理通用功能
4. **長期可擴展** - 新增模組時只需修改中樞

---

## 二、架構層次圖

```
┌─────────────────────────────────────────────────────────────────┐
│                       具體 EA 檔案層                             │
│              (Grids.mq4 / Recovery.mq4 / Trend.mq4)             │
│                                                                 │
│   只需實作：                                                     │
│   ├─ GetTradeSignal()      ← 多空判斷邏輯                       │
│   ├─ ShouldOpenFirst()     ← 首單開啟條件                       │
│   ├─ ShouldAddPosition()   ← 加倉條件                           │
│   ├─ CalculateLots()       ← 手數計算                           │
│   ├─ OnCustomTick()        ← 自訂 Tick 邏輯                     │
│   └─ 自訂參數和專屬邏輯                                          │
└─────────────────────────────────────────────────────────────────┘
                              │ 繼承
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CEACore（中樞 Class）                         │
│                    Libs/EACore/CEACore.mqh                      │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    整合模組                              │   │
│   │  ├─ CTradeCore            (交易核心)                    │   │
│   │  ├─ CHedgeClose           (對沖平倉)                    │   │
│   │  ├─ CProfitTrailingStop   (獲利追蹤停利)                │   │
│   │  ├─ CTradeArrowManager    (交易箭頭顯示)                │   │
│   │  ├─ CRecoveryProfit       (獲利通訊)                    │   │
│   │  ├─ CChartPanelCanvas     (UI 面板)                     │   │
│   │  └─ CTimerManager         (計時器管理)                  │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    核心功能（委託給 TradeCore）           │   │
│   │  ├─ 生命週期管理    (OnInitCore/OnTickCore/OnDeinitCore)│   │
│   │  ├─ 訂單管理        (開單/平倉/計數/浮動盈虧)           │   │
│   │  ├─ 風險控制        (回撤保護/手數限制/點差檢查)        │   │
│   │  ├─ 日誌系統        (分級日誌/檔案輸出)                 │   │
│   │  ├─ 狀態管理        (運行/暫停/錯誤)                    │   │
│   │  └─ 計時器管理      (多計時器支援)                      │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    抽象方法（子類實作）                   │   │
│   │  ├─ virtual int    GetTradeSignal()                     │   │
│   │  ├─ virtual bool   ShouldOpenFirst(int direction)       │   │
│   │  ├─ virtual bool   ShouldAddPosition(int direction)     │   │
│   │  ├─ virtual double CalculateLots(int level)             │   │
│   │  ├─ virtual double CalculateGridDistance(int level)     │   │
│   │  ├─ virtual void   OnCustomTick()                       │   │
│   │  ├─ virtual void   OnCustomTimer(int timerId)           │   │
│   │  └─ virtual void   OnRiskTriggered()                    │   │
│   └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │ 使用
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Libs 模組層                                │
│                                                                 │
│   Libs/                                                         │
│   ├─ EACore/              ← EA 核心模組                         │
│   │  ├─ CEACore.mqh         (中樞類別) ✓                       │
│   │  ├─ CTimerManager.mqh   (計時器管理) ✓                     │
│   │  ├─ Utils.mqh           (工具函數)                         │
│   │  ├─ Logic.md            (模組說明) ✓                       │
│   │  └─ EABase.mqh          (參考用)                           │
│   │                                                             │
│   ├─ TradeCore/           ← 交易核心模組 ✓                      │
│   │  ├─ CTradeCore.mqh      (交易核心整合) ✓                   │
│   │  ├─ COrderManager.mqh   (訂單管理) ✓                       │
│   │  ├─ CRiskManager.mqh    (風險控制) ✓                       │
│   │  ├─ CPositionManager.mqh(持倉管理) ✓                       │
│   │  ├─ CTradeUtils.mqh     (交易工具函數) ✓                   │
│   │  ├─ CHedgeClose.mqh     (對沖平倉) ✓                       │
│   │  ├─ CProfitTrailingStop.mqh (獲利追蹤) ✓                   │
│   │  └─ Logic.md            (模組說明) ✓                       │
│   │                                                             │
│   ├─ TradeArrowManager/   ← 交易箭頭                            │
│   ├─ RecoveryProfit/      ← 獲利通訊                            │
│   ├─ GridsCore/           ← 網格交易核心                        │
│   └─ UI/                  ← UI 面板                             │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、CEACore 類別設計

### 3.1 整合模組

CEACore 整合以下模組，可透過設定啟用/停用：

- `CTradeCore` - 交易核心（必要）
- `CHedgeClose` - 對沖平倉（可選）
- `CProfitTrailingStop` - 獲利追蹤停利（可選）
- `CTradeArrowManager` - 交易箭頭（可選）
- `CRecoveryProfit` - 獲利通訊（可選）
- `CChartPanelCanvas` - UI 面板（可選）
- `CTimerManager` - 計時器管理（可選）

### 3.2 抽象方法

子類需要實作的方法：

- `GetTradeSignal()` - 返回多空信號
- `ShouldOpenFirst(direction)` - 判斷是否開首單
- `ShouldAddPosition(direction)` - 判斷是否加倉
- `CalculateLots(level)` - 計算指定層級手數
- `CalculateGridDistance(level)` - 計算指定層級間距
- `OnCustomTick()` - 自訂 OnTick 邏輯
- `OnCustomTimer(timerId)` - 自訂計時器回調
- `OnRiskTriggered()` - 風險觸發時的處理

### 3.3 設定方法

**基本設定**
- `SetMagic(int)` - 設定 Magic Number
- `SetSymbol(string)` - 設定交易商品
- `SetGroupId(string)` - 設定組別 ID
- `SetSlippage(int)` - 設定滑點
- `SetEAName(string)` - 設定 EA 名稱
- `SetEAVersion(string)` - 設定 EA 版本

**風控設定**
- `SetMaxDrawdown(double)` - 設定最大回撤 %
- `SetMaxLots(double)` - 設定最大手數
- `SetMaxSpread(double)` - 設定最大點差
- `SetMaxOrders(int)` - 設定最大訂單數

**模組啟用**
- `EnableHedgeClose(bool)` - 啟用對沖平倉
- `EnableProfitTrailing(bool)` - 啟用獲利追蹤
- `EnableArrows(bool)` - 啟用交易箭頭
- `EnableRecoveryProfit(bool)` - 啟用獲利通訊
- `EnableChartPanel(bool)` - 啟用 UI 面板
- `EnableTimer(bool)` - 啟用計時器

---

## 四、TradeCore 交易核心模組

### 4.1 模組結構

```
Libs/TradeCore/
├── CTradeCore.mqh          ← 主入口，整合所有子模組
├── COrderManager.mqh       ← 訂單管理（開單/平倉/修改）
├── CRiskManager.mqh        ← 風險控制（回撤/手數/點差/保證金）
├── CPositionManager.mqh    ← 持倉管理（計數/統計/查詢）
├── CTradeUtils.mqh         ← 工具函數（靜態方法）
├── CHedgeClose.mqh         ← 對沖平倉模組
├── CProfitTrailingStop.mqh ← 獲利回跌停利模組
└── Logic.md                ← 模組說明
```

### 4.2 主要功能

**COrderManager - 訂單管理**
- 開單（含停損停利）
- 平倉（單筆/全部）
- 修改訂單
- 錯誤處理

**CRiskManager - 風險控制**
- 回撤檢查
- 手數限制
- 點差檢查
- 保證金檢查

**CPositionManager - 持倉管理**
- 訂單計數（緩存優化）
- 手數統計
- 浮動盈虧計算
- 平均價格計算

**CTradeUtils - 工具函數（靜態）**
- 手數驗證
- 價格標準化
- 點數轉換
- 新 K 棒檢測
- 錯誤描述

**CHedgeClose - 對沖平倉**
- 先下對沖單鎖住持倉
- 使用 OrderCloseBy 互相平倉
- 失敗時自動改用一般平倉

**CProfitTrailingStop - 獲利追蹤停利**
- 獲利達閾值後啟動追蹤
- 獲利回跌到指定百分比時觸發平倉
- 可搭配對沖平倉使用

---

## 五、CTimerManager 計時器管理

### 5.1 設計目的

- 支援多個獨立計時器
- 統一管理計時器生命週期
- 避免 MT4 單一 EventSetTimer 限制

### 5.2 使用範例

```mql4
class CGridsEA : public CEACore
{
private:
   int m_uiTimerId;
   int m_recoveryTimerId;
   
public:
   virtual int OnInitCore() override
   {
      CEACore::OnInitCore();
      
      m_uiTimerId = AddTimer("UI更新", 1);
      m_recoveryTimerId = AddTimer("Recovery通訊", 5);
      
      return INIT_SUCCEEDED;
   }
   
   virtual void OnCustomTimer(int timerId) override
   {
      if(timerId == m_uiTimerId)
         UpdateUI();
      else if(timerId == m_recoveryTimerId)
         SyncRecoveryProfit();
   }
};
```

---

## 六、檔案結構

```
專案根目錄/
├── Libs/
│   ├── EACore/
│   │   ├── CEACore.mqh           ← 中樞類別 ✓
│   │   ├── CEACore_Test.mq4      ← 編譯測試 ✓
│   │   ├── CTimerManager.mqh     ← 計時器管理 ✓
│   │   ├── Utils.mqh             ← 工具函數
│   │   ├── Logic.md              ← 模組說明 ✓
│   │   └─ EABase.mqh            ← 參考用
│   │
│   ├── TradeCore/                ← 交易核心 ✓
│   │   ├── CTradeCore.mqh        ← 交易核心整合 ✓
│   │   ├── COrderManager.mqh     ← 訂單管理 ✓
│   │   ├── CRiskManager.mqh      ← 風險控制 ✓
│   │   ├── CPositionManager.mqh  ← 持倉管理 ✓
│   │   ├── CTradeUtils.mqh       ← 交易工具函數 ✓
│   │   ├── CHedgeClose.mqh       ← 對沖平倉 ✓
│   │   ├── CProfitTrailingStop.mqh ← 獲利追蹤 ✓
│   │   └── Logic.md              ← 模組說明 ✓
│   │
│   ├── HedgeClose/               ← (舊位置，保留相容)
│   ├── ProfitTrailingStop/       ← (舊位置，保留相容)
│   ├── TradeArrowManager/
│   ├── RecoveryProfit/
│   ├── GridsCore/
│   └── UI/
│
├── Grids 1.9/
│   ├── Grids 1.19.mq4            ← 現有版本
│   ├── Grids 2.0.mq4             ← 新版（使用 CEACore）
│   └── 整體架構.md               ← 本文件
│
└── Recovery 1.3 Test/
    └── Recovery.mq4
```

---

## 七、實作計劃

### 階段 1：基礎建設 ✓ 完成
- [x] 建立 CTimerManager.mqh
- [x] 建立 TradeCore 模組
  - [x] CTradeCore.mqh
  - [x] COrderManager.mqh
  - [x] CRiskManager.mqh
  - [x] CPositionManager.mqh
  - [x] CTradeUtils.mqh
  - [x] Logic.md
- [x] 建立 CEACore.mqh
- [x] 建立 Logic.md
- [x] 編譯測試通過

### 階段 2：功能整合 ✓ 完成
- [x] CEACore 整合 TradeCore
- [x] CEACore 整合其他 Libs 模組
- [x] 實作日誌系統
- [x] 實作計時器管理
- [x] 整合 CHedgeClose 到 TradeCore
- [x] 整合 CProfitTrailingStop 到 TradeCore

### 階段 3：遷移測試（待進行）
- [ ] 建立 CGridsEA 子類
- [ ] 遷移網格交易邏輯
- [ ] 測試功能完整性
- [ ] 效能比較

### 階段 4：優化擴展（待進行）
- [ ] 根據測試結果調整介面
- [ ] 新增更多通用功能
- [ ] 建立其他策略 EA
- [ ] 完善文件

---

## 八、使用範例

### 8.1 建立子類

```mql4
#include "../Libs/EACore/CEACore.mqh"

class CMyEA : public CEACore
{
public:
   virtual int GetTradeSignal() override
   {
      // 你的多空判斷邏輯
      return SIGNAL_NEUTRAL;
   }
   
   virtual void OnCustomTick() override
   {
      // 你的自訂 OnTick 邏輯
   }
};
```

### 8.2 在 EA 主檔案中使用

```mql4
CMyEA g_ea;

int OnInit()
{
   g_ea.SetMagic(12345);
   g_ea.SetEAName("MyEA");
   g_ea.SetEAVersion("1.0");
   g_ea.SetMaxDrawdown(20.0);
   
   g_ea.EnableChartPanel(true);
   g_ea.EnableHedgeClose(true);
   
   return g_ea.OnInitCore();
}

void OnTick()   { g_ea.OnTickCore(); }
void OnTimer()  { g_ea.OnTimerCore(); }
void OnDeinit(const int reason) { g_ea.OnDeinitCore(reason); }
```

---

## 九、注意事項

1. **向後相容**：現有 Grids 1.19.mq4 保持不變，新架構在 2.0 版本實作
2. **漸進遷移**：先建立骨架，逐步移植功能，確保每步都可編譯運行
3. **模組獨立**：Libs 下的模組保持獨立，可單獨使用
4. **測試優先**：每個階段完成後進行完整測試
5. **舊路徑相容**：HedgeClose 和 ProfitTrailingStop 舊路徑保留，確保現有 EA 不受影響

---

## 十、版本紀錄

- v1.0 (2025-12-31) - 初版架構設計
- v1.1 (2025-12-31) - 新增 TradeCore 交易核心模組
- v1.2 (2025-12-31) - 完成 CEACore 中樞類別，編譯測試通過
- v1.3 (2025-12-31) - 整合 CHedgeClose 和 CProfitTrailingStop 到 TradeCore
