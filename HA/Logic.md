# HA Adaptive EA 交易邏輯說明文件 (v1.06)

本文件詳述 `HA/HA_Adaptive_EA.mq4` 的核心交易邏輯、進場機制與出場策略。

## 一、 核心指標與環境偵測

### 1. 指標選用：Heiken Ashi (Smoothed)
*   **計算原理**：透過兩層平滑處理（第一層 `MaMethod/Period`，第二層 `MaMethod2/Period2`）。
*   **HMA 支援**：支援 Hull Moving Average (HMA)，預設採用 HMA(12, 6) 以過濾震盪。

---

## 二、 進場機制 (Entry Logic)
*   **時機**：每一根新 K 棒開盤。
*   **交易方向**：根據上一根 HA 顏色判定（順勢/逆勢）。

---

## 三、 出場邏輯 (Exit Logic)

### 1. 單筆持倉限制 (K-Bar Limit)
當單子持有超過 `Max_Bars_Limit` 根 K 棒時，觸發以下五種平倉模式之一：
*   **`EXIT_MIN_LOSS`**：僅平掉盈虧 < 0 且**虧損最小**（最接近 0）的單子。
*   **`EXIT_MAX_LOSS`**：僅平掉盈虧 < 0 且**虧損最大**（負數絕對值最大）的單子。
*   **`EXIT_MIN_PROFIT`**：僅平掉盈虧 > $1.0 且**獲利最小**（最接近 1）的單子。
*   **`EXIT_MAX_PROFIT`**：僅平掉盈虧 > $1.0 且**獲利最大**（賺最多）的單子。
*   **`EXIT_OLDEST`**：平掉**開倉時間最早**的單子（不限盈虧）。

### 2. 全局盈虧移動止盈 (Global Trailing)
*   **激活門檻**：總獲利達到目標值（如 $10）啟動。
*   **回跌觸發**：利潤從最高點下降達百分比（如 25%）時，執行全平倉。

---

## 四、 執行技術：智慧對沖平倉 (`SmartHedgeClose`)
1.  **對沖鎖單**：瞬間平衡多空手數，鎖死盈虧。
2.  **遞迴對沖 (`OrderCloseBy`)**：省去一倍點差費用。
3.  **坐標式標註**：在平倉地點的時間與價格坐標處，標註該次結算的總盈虧（桔紅/鮮綠）。
