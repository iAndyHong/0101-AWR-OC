# HA Adaptive EA 交易邏輯說明文件 (v1.06)

本文件詳述 `HA/HA_Adaptive_EA.mq4` 的核心交易邏輯、進場機制與出場策略。

## 一、 核心指標與環境偵測

### 1. 指標選用：Heiken Ashi (Smoothed)
*   **計算原理**：透過兩層平滑處理（第一層 `MaMethod/Period`，第二層 `MaMethod2/Period2`）。
*   **HMA 支援**：支援 Hull Moving Average (HMA)，預設採用 HMA(12, 6) 以過濾震盪。

---

## 二、 進場機制 (Entry Logic)
*   **時機**：每一根新 K 棒開盤。
*   **交易方向**：根據上一根 HA 顏色判定（順勢/逆勢）。

---

## 三、 出場邏輯 (Exit Logic)

### 1. 單筆持倉限制 (K-Bar Limit)
當單子持有超過 `Max_Bars_Limit` 根 K 棒時，觸發以下五種平倉模式之一：
*   **`EXIT_MIN_LOSS`**：僅平掉盈虧 < 0 且**虧損最小**（最接近 0）的單子。
*   **`EXIT_MAX_LOSS`**：僅平掉盈虧 < 0 且**虧損最大**（負數絕對值最大）的單子。
*   **`EXIT_MIN_PROFIT`**：僅平掉盈虧 > $1.0 且**獲利最小**（最接近 1）的單子。
*   **`EXIT_MAX_PROFIT`**：僅平掉盈虧 > $1.0 且**獲利最大**（賺最多）的單子。
*   **`EXIT_OLDEST`**：平掉**開倉時間最早**的單子（不限盈虧）。

### 2. 全局盈虧移動止盈 (Global Trailing)
*   **激活門檻**：總獲利達到目標值（如 $10）啟動。
*   **回跌觸發**：利潤從最高點下降達百分比（如 25%）時，執行全平倉。

---

## 五、 版本演進紀錄

### v1.52
*   **專業 Canvas 面板**：引入自定義 Canvas 繪圖引擎，提供實時多空統計、均價線顯示。
*   **效能優化**：優化訂單掃描與 UI 更新頻率，減少系統資源佔用。

### v1.53
*   **ADX 指標接入**：整合 ADX、+DI、-DI 指標判斷。
*   **UI 強化**：面板最後一行新增 ADX 數據顯示。

### v1.54 (關鍵穩定版)
*   **ADX 自適應執行系統**：
    *   **強趨勢 (ADX > High)**：強制切換為 **順勢 + 反馬丁**。
    *   **弱震盪 (ADX < Low)**：強制切換為 **逆勢 + 馬丁**。
    *   **DI 覆蓋**：可選擇讓 DI 交叉決定進場方向。
*   **穩定性修正**：恢復與 v1.52 一致的 LWMA 平滑預設值，修復 HMA 過於敏感導致的爆倉問題。
*   **邏輯重構**：代碼模組化分區，優化 `OnTick()` 執行序，優先更新帳戶快照。

### v1.55 (部位接管與系統模式版)
*   **重啟自動同步**：
    *   **初始化部位接管**：EA 啟動時自動掃描 Magic Number 並歸檔至變數紀錄。
    *   **UI 歷史恢復**：修復 EA 重啟後面板最高獲利、最低保證金等統計數據歸零的問題。
    *   **UI 防衝突機制**：確保 EA 中途退出再進入時，Canvas 物件能正確重新初始化並立即顯示。
*   **系統運行模式 (System_Mode)**：
    *   **SYS_NORMAL (正常交易)**：執行所有進場、加碼與平倉邏輯。
    *   **SYS_EXIT_ONLY (僅平倉)**：停止所有新開倉與加碼行為，僅保留全局獲利結算邏輯（讓現有單子跑完出場）。
    *   **SYS_PAUSED (暫停交易)**：完全停止 EA 運作，UI 停止更新，不執行任何交易檢查。
