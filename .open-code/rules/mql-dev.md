# MQL4/MQL5 專案開發綜合規範

本文件整合了 MQL 開發的所有技術規範、工作流程與安全守則。

## 1. 規格驅動開發 (Spec-Driven Development)

專案遵循「規格先行」原則，三個核心文件為最終依據：
- `requirements.md`：功能需求。
- `design.md`：架構設計。
- `ai-todo.md`：任務追蹤。

### 變更同步流程 (`sync spec`)
每當需求調整或使用者說明新行為時，必須執行以下流程：
1. **更新 `requirements.md`**：明確記錄需求變更。
2. **調整 `design.md`**：更新系統架構與模組設計。
3. **同步 `ai-todo.md`**：新增或更新對應的任務。
4. **確認實作**：在得到使用者同意後，才開始編碼。

## 2. 開發環境與原則
- **主要語言**：MQL4、MQL5 (注意版本差異，禁止混用)。
- **輔助語言**：Python (用於複雜計算與資料處理)。
- **工具鏈**：MetaEditor、Docker、Git。
- **優先級排序**：
  1. **風險控制** > 交易邏輯
  2. **策略穩定性** > 執行效率
  3. **回測驗證** > 理論模型
  4. **資金管理** > 獲利能力

## 3. MQL 程式碼風格與規範

### 命名規範
- 變數：`camelCase` (如 `myVariable`)
- 函數：`PascalCase` (如 `CalculateProfit`)
- 常數：`UPPER_CASE` (如 `MAX_ORDERS`)
- 全域變數：建議使用 `g_` 前綴 (如 `g_isInitialized`)
- 參數：`parameter_name`

### 註解與格式
- **註解**：必須使用**繁體中文**，重點解釋交易邏輯、風控機制與演算法原理。
- **格式**：4 空格縮排，行長限制 100 字元。
- **規範**：禁止使用魔術數字 (Magic Numbers)，必須定義具名常數。

### 語言特性事實
- **無需預先聲明**: 函數可以在調用之後定義，禁止添加不必要的函數前置聲明。
- **OnTimer**: 在策略測試器（Strategy Tester）中會正常觸發。
- **性能優化**: 善用靜態變數緩存結果；在 `OnTick` 中加入條件式更新。

## 4. 代碼排版規範 (Code Formatting)

### 函數與區塊註解格式
- 註解行若以 `//|` 開頭，**必須移除尾部的裝飾性邊框 `|` 及多餘空格**。
- 只保留純文字內容，保持簡潔。

**範例**：
```cpp
// ❌ 錯誤格式
//| 常數定義                                                         |

// ✅ 正確格式
//| 常數定義
```

### 全局變數和外部變數對齊
所有變數宣告必須嚴格對齊，以提高可讀性。

**對齊規則**：
1. **類型對齊**：所有變數類型左對齊。
2. **變數名對齊**：在統一列位置開始。
3. **賦值對齊**：等號 (`=`) 在統一列位置。
4. **註解對齊**：行尾註解在統一列位置。
5. **分組排列**：相關變數分組，組間留空行。

**正確範例**：
```mql4
sinput string  TEHelp                    = "----------------";   // 交易入場幫助
input  int     TradeDirection            = 1;                    // 交易方向
input  double  Lots                      = 0.01;                 // 初始手數

bool           g_isInitialized           = false;
double         g_currentLots             = 0.0;
```

### 外部變數區塊格式 (`sinput`)
區塊標題變數一律使用 `sinput` 並簡化分隔線：
```mql4
// ✅ 新格式 (必須使用)
sinput string  Block_Help                = "----------------";   // 區塊功能說明
```

## 5. 日誌與除錯規範 (Logging & Debugging)

### 系統訊息
- 所有 `Print()` 輸出和日誌訊息必須使用 **繁體中文**。
- 必要時定義 `extern string LogFile = "debug.txt";` 將詳細除錯訊息寫入檔案，避免日誌膨脹。

### 交易返回值檢查 (CRITICAL)
- 所有交易命令 (開單/平倉/修改) **必須** 接收並檢查返回值。
- 若交易失敗，必須輸出錯誤代碼 (Error Code) 與說明，不可忽略。

## 6. 檔案編輯與安全守則

### 編輯前備份 (必須自動執行)
在修改任何 `.mq4` 或 `.mq5` 檔案前，必須建立備份：
- 備份目錄: `Backups/`
- 命名格式: `原檔名_MMDD_HHMMSS-1.副檔名`

### 編輯工具與驗證
- **推薦工具**: 使用 `Edit` 工具進行精確替換。
- **禁止指令**: 絕對禁止使用 `sed`、`awk` 或 `strReplace` 等可能導致檔案損壞的工具。
- **編譯驗證**: 必須使用 `./compile.sh "檔案名稱.mq4"` 進行編譯，嚴禁直接調用 MetaEditor。
- **確認流程**: 
  1. 建立備份。
  2. 執行修改。
  3. 執行 `./compile.sh` 驗證。
  4. 檢查 `lsp_diagnostics`。

## 7. MQL 特定禁令與陷阱
- ❌ **禁止危險操作**：不直接修改生產中 EA (需先平倉)。
- ❌ **禁止忽視錯誤**：交易函數 (OrderSend 等) 必須檢查回傳值。
- ❌ **禁止忽視風控**：必須嚴格處理停損 (SL)、止盈 (TP) 與倉位大小計算。
- ❌ **嚴禁混淆版本**：不要假設 MQL4/MQL5 行為完全一致。
- ✅ **正規化**：始終對價格與手數進行正規化 (`NormalizeDouble`, `MathFloor` 等)。

## 8. 專案版本升級自動化 (Version Upgrade SOP)

當用戶下達「更新到版本 X.X」指令時，必須嚴格執行以下連鎖動作：

### 第一步：目錄與檔案物理備份
1.  **專案目錄複製**: 將當前版本資料夾完整複製為新版本資料夾。
2.  **Libs 副本建立**: 為所有引用的類別備份對應新版本號的副本。
    - 範例: `Libs/EACore/CEACore_v2.1.mqh` -> `Libs/EACore/CEACore_v2.2.mqh`
    - 同步處理 `Logic_vX.X.md` 文件。

### 第二步：代碼內部連結與版本更新
1.  **重命名主程式**: 將新資料夾下的 `.mq4/mq5` 檔案重新命名以符合版本號。
2.  **更新版本宣告**: 搜尋並修改代碼中的 `m_eaVersion` 或 `@version` 宣告。
3.  **重定向 Include**: 修改 `#include` 路徑，使其精確指向 `Libs/` 下新建立的版本副本。

### 第三步：驗證
1.  針對新生成的版本資料夾執行 `./compile.sh`。
2.  確保 `lsp_diagnostics` 在新版本環境下完全乾淨。
