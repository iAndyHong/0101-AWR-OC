# What If - 風險分析與策略討論

## 討論日期：2024-12-13

---

## 核心問題：逆勢攤平的爆倉風險

### 問題描述

逆勢攤平策略（價格下跌時 Buy 加倉，價格上漲時 Sell 加倉）存在一個致命弱點：

**如果趨勢強烈且持續，會發生什麼？**

- 例如：市場強勢上漲，Sell 籃子會不斷加倉
- 每次加倉都增加持倉成本和浮虧
- 最終可能因為保證金不足而爆倉
- 不僅沒有恢復虧損，反而害得帳戶爆倉

### 目前的保護機制

我們已經實作「趨勢翻轉時停止加倉」的機制：
- Buy 籃子：趨勢向下時停止加倉
- Sell 籃子：趨勢向上時停止加倉

**但這個機制的限制**：
- 只能在趨勢**已經翻轉**後才停止
- 無法預防強趨勢期間的持續虧損
- 如果趨勢持續很長時間，帳戶可能已經承受巨大浮虧

---

## 解決方案討論

### 方案 1：趨勢強度過濾器（第二指標）

**概念**：加入趨勢強度判斷，區分「強趨勢」和「弱趨勢/震盪」

| 市場狀態 | 加倉策略 |
|----------|----------|
| 強趨勢 | 停止逆勢加倉，或改為順勢追蹤 |
| 弱趨勢/震盪 | 允許逆勢攤平 |

**可用的趨勢強度指標**：

| 指標 | 判斷方式 | 優點 | 缺點 |
|------|----------|------|------|
| ADX (Average Directional Index) | ADX > 25 視為強趨勢 | 經典指標，廣泛使用 | 有滯後性 |
| ATR 變化率 | ATR 急速擴大表示趨勢加速 | 反應快速 | 可能誤判波動 |
| Super Trend 斜率 | 斜率越陡表示趨勢越強 | 已有 Super Trend，易整合 | 需要額外計算 |
| 連續同向 K 線數量 | 連續 N 根同向 K 線視為強趨勢 | 簡單直觀 | 可能過於敏感 |

**ADX 判斷標準（業界常用）**：
- ADX < 20：無趨勢（震盪市場）
- ADX 20-25：弱趨勢
- ADX 25-50：強趨勢
- ADX > 50：極強趨勢

---

### 方案 2：動態加倉間距

**概念**：趨勢越強，加倉間距越大，降低加倉頻率

```
基礎間距 = 500 點
趨勢強度係數 = ADX / 25
實際間距 = 基礎間距 × 趨勢強度係數

範例：
- ADX = 15（震盪）：間距 = 500 × 0.6 = 300 點（更密集）
- ADX = 25（正常）：間距 = 500 × 1.0 = 500 點
- ADX = 40（強趨勢）：間距 = 500 × 1.6 = 800 點（更稀疏）
```

**優點**：
- 不完全停止加倉，仍有機會攤平
- 自動適應市場狀態

**缺點**：
- 強趨勢時仍會加倉，只是頻率降低
- 無法完全避免爆倉風險

---

### 方案 3：最大浮虧限制

**概念**：設定籃子的最大浮虧金額或百分比

```
如果 籃子浮虧 > 最大允許浮虧：
    停止該籃子加倉
    等待趨勢翻轉或手動處理
```

**參數設計**：
- `MaxBasketDrawdown`：單一籃子最大浮虧（金額或百分比）
- `MaxTotalDrawdown`：所有籃子總浮虧上限

**優點**：
- 直接控制風險
- 簡單明確

**缺點**：
- 可能在即將反轉前停止加倉
- 錯過攤平機會

---

### 方案 4：混合策略（推薦）

**概念**：結合趨勢強度判斷，動態切換策略

| ADX 值 | 市場狀態 | Buy 籃子策略 | Sell 籃子策略 |
|--------|----------|-------------|--------------|
| < 20 | 震盪 | 逆勢攤平 | 逆勢攤平 |
| 20-30 | 弱趨勢 | 逆勢攤平（加大間距） | 逆勢攤平（加大間距） |
| > 30 | 強趨勢 | 順勢追蹤或停止 | 順勢追蹤或停止 |

**詳細邏輯**：

```
震盪市場（ADX < 20）：
  - 最適合逆勢攤平的環境
  - 價格在區間內來回波動
  - 攤平後容易達到止盈

弱趨勢市場（ADX 20-30）：
  - 謹慎使用逆勢攤平
  - 加大間距，減少加倉次數
  - 密切監控趨勢變化

強趨勢市場（ADX > 30）：
  - 停止逆勢加倉，保護帳戶
  - 可選擇：
    a) 完全停止加倉，等待趨勢結束
    b) 切換為順勢追蹤模式
    c) 平倉止損，認賠出場
```

**優點**：
- 在適合的環境下使用逆勢攤平獲利
- 在危險的環境下保護帳戶
- 靈活適應不同市場狀態

**缺點**：
- 實作較複雜
- 需要調整多個參數

---

## 實作建議

### 如果要實作方案 4，需要：

1. **新增 ADX 計算函數**
   - 使用 MQL4 內建的 `iADX()` 函數
   - 設定 ADX 週期參數（建議 14）

2. **新增外部參數**
   ```mql4
   input int      ADX_Period           = 14;      // ADX 週期
   input double   ADX_WeakThreshold    = 20.0;    // 弱趨勢閾值
   input double   ADX_StrongThreshold  = 30.0;    // 強趨勢閾值
   input bool     ADX_EnableFilter     = true;    // 啟用 ADX 過濾
   ```

3. **修改加倉邏輯**
   - 在加倉前檢查 ADX 值
   - 根據 ADX 值決定是否允許加倉
   - 可選：根據 ADX 值調整加倉間距

4. **新增圖表顯示**
   - 在面板上顯示當前 ADX 值
   - 顯示當前市場狀態（震盪/弱趨勢/強趨勢）

---

## 風險提醒

無論採用哪種方案，都需要注意：

1. **沒有完美的策略**：任何策略都有其適用環境和風險
2. **資金管理最重要**：不要用超過承受能力的資金交易
3. **測試再測試**：任何修改都需要在策略測試器中充分測試
4. **監控帳戶**：即使有自動保護機制，也要定期檢查帳戶狀態
5. **設定止損**：考慮設定帳戶級別的最大虧損限制

---

## 下一步行動

- [ ] 決定採用哪個方案
- [ ] 設計詳細的參數和邏輯
- [ ] 在策略測試器中測試不同市場環境
- [ ] 評估風險和收益比
- [ ] 實作並部署

---

## 討論記錄

**2024-12-13**：
- 提出逆勢攤平的爆倉風險問題
- 討論四種可能的解決方案
- 建議採用方案 4（混合策略）作為最安全的做法
- 目前僅為討論，尚未修改代碼
